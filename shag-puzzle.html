<script>
  let size = 4;
  let tiles = [];

  let moves = 0;
  let seconds = 0;
  let timerId = null;

  function formatTime(sec) {
    const m = Math.floor(sec / 60);
    const s = sec % 60;
    const mm = m < 10 ? "0" + m : String(m);
    const ss = s < 10 ? "0" + s : String(s);
    return mm + ":" + ss;
  }

  function updateStats() {
    const movesEl = document.getElementById("movesCount");
    const timeEl = document.getElementById("timeCount");
    if (movesEl) movesEl.textContent = moves;
    if (timeEl) timeEl.textContent = formatTime(seconds);
  }

  function resetStats() {
    moves = 0;
    seconds = 0;
    stopTimer();
    updateStats();
  }

  function startTimer() {
    if (timerId) return;
    timerId = setInterval(() => {
      seconds++;
      updateStats();
    }, 1000);
  }

  function stopTimer() {
    if (timerId) {
      clearInterval(timerId);
      timerId = null;
    }
  }

  function startGame(n) {
    size = n;
    document.getElementById("menu").classList.add("hidden");
    document.getElementById("game").classList.remove("hidden");
    document.getElementById("win").classList.add("hidden");
    document.getElementById("levelTitle").textContent = "Ð Ñ–Ð²ÐµÐ½ÑŒ " + n + "Ã—" + n;
    newGame();
  }

  function backToMenu() {
    stopTimer();
    document.getElementById("menu").classList.remove("hidden");
    document.getElementById("game").classList.add("hidden");
    document.getElementById("win").classList.add("hidden");
  }

  function isSolvable(arr) {
    const n = size;
    const emptyIndex = arr.indexOf(0);
    const emptyRow = n - Math.floor(emptyIndex / n);
    const flatTiles = arr.filter(n => n !== 0);

    let inversions = 0;
    for (let i = 0; i < flatTiles.length; i++) {
      for (let j = i + 1; j < flatTiles.length; j++) {
        if (flatTiles[i] > flatTiles[j]) {
          inversions++;
        }
      }
    }

    if (n % 2 !== 0) {
      return inversions % 2 === 0;
    } else {
      if (emptyRow % 2 !== 0) {
        return inversions % 2 === 0;
      } else {
        return inversions % 2 !== 0;
      }
    }
  }

  function newGame() {
    document.getElementById("win").classList.add("hidden");
    document.getElementById("game").classList.remove("hidden");

    const grid = document.getElementById("grid");
    grid.style.gridTemplateColumns = `repeat(${size}, 1fr)`;

    let numbers;
    let solvable = false;

    while (!solvable) {
      numbers = Array.from({ length: size * size - 1 }, (_, i) => i + 1);
      numbers.sort(() => Math.random() - 0.5);
      numbers.push(0);
      solvable = isSolvable(numbers);
    }

    tiles = numbers;
    draw();
    resetStats();
    startTimer();
  }

  function draw() {
    const grid = document.getElementById("grid");
    grid.innerHTML = "";
    tiles.forEach((n, i) => {
      const div = document.createElement("div");
      div.className = "tile" + (n === 0 ? " empty" : "");
      if (n !== 0) div.textContent = n;
      div.onclick = () => move(i);
      grid.appendChild(div);
    });
  }

  function move(i) {
    const empty = tiles.indexOf(0);
    const row = Math.floor(i / size), col = i % size;
    const er = Math.floor(empty / size), ec = empty % size;

    if (Math.abs(row - er) + Math.abs(col - ec) === 1) {
      [tiles[i], tiles[empty]] = [tiles[empty], tiles[i]];
      moves++;
      updateStats();
      draw();
      if (checkWin()) showWin();
    }
  }

  function checkWin() {
    for (let i = 0; i < tiles.length - 1; i++) {
      if (tiles[i] !== i + 1) return false;
    }
    return tiles[tiles.length - 1] === 0;
  }

  // ---- Ð—Ð‘Ð•Ð Ð•Ð–Ð•ÐÐÐ¯ Ð Ð•ÐšÐžÐ Ð”Ð†Ð’ ----
  function saveAndShowRecord() {
    const key = "shag15_record_" + size; // Ð¾ÐºÑ€ÐµÐ¼Ð¸Ð¹ Ñ€ÐµÐºÐ¾Ñ€Ð´ Ð´Ð»Ñ 3Ã—3, 4Ã—4, 5Ã—5
    let isRecord = false;
    let prevData = null;

    try {
      const prev = localStorage.getItem(key);
      if (prev) {
        prevData = JSON.parse(prev);
      }
    } catch (e) {
      // ÑÐºÑ‰Ð¾ Ñ‰Ð¾ÑÑŒ Ð½Ðµ Ñ‚Ð°Ðº Ð· localStorage â€“ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ñ–Ð³Ð½Ð¾Ñ€ÑƒÑ”Ð¼Ð¾
      prevData = null;
    }

    if (!prevData) {
      // Ñ‰Ðµ Ð½Ðµ Ð±ÑƒÐ»Ð¾ Ñ€ÐµÐºÐ¾Ñ€Ð´Ñƒ
      isRecord = true;
    } else {
      // Ð¼ÐµÐ½ÑˆÐµ Ñ…Ð¾Ð´Ñ–Ð² â€“ ÐºÑ€Ð°Ñ‰Ðµ
      if (moves < prevData.moves) {
        isRecord = true;
      } else if (moves === prevData.moves && seconds < prevData.seconds) {
        // Ð¾Ð´Ð½Ð°ÐºÐ¾Ð²Ð¾ Ñ…Ð¾Ð´Ñ–Ð², Ð°Ð»Ðµ Ð¼ÐµÐ½ÑˆÐ¸Ð¹ Ñ‡Ð°Ñ â€“ Ñ‚ÐµÐ¶ Ð½Ð¾Ð²Ð¸Ð¹ Ñ€ÐµÐºÐ¾Ñ€Ð´
        isRecord = true;
      }
    }

    if (isRecord) {
      const toSave = { moves: moves, seconds: seconds };
      try {
        localStorage.setItem(key, JSON.stringify(toSave));
      } catch (e) {
        // ÑÐºÑ‰Ð¾ Ð½Ðµ Ð²Ð´Ð°Ð»Ð¾ÑÑŒ Ð·Ð±ÐµÑ€ÐµÐ³Ñ‚Ð¸ â€“ Ð½Ñ–Ñ‡Ð¾Ð³Ð¾ ÑÑ‚Ñ€Ð°ÑˆÐ½Ð¾Ð³Ð¾
      }
      alert(
        "ðŸŽ‰ ÐÐ¾Ð²Ð¸Ð¹ Ñ€ÐµÐºÐ¾Ñ€Ð´ Ð´Ð»Ñ Ñ€Ñ–Ð²Ð½Ñ " +
        size + "Ã—" + size +
        "!\nÐ¥Ð¾Ð´Ð¸: " + moves +
        "\nÐ§Ð°Ñ: " + formatTime(seconds)
      );
    } else if (prevData) {
      alert(
        "Ð¢Ð²Ñ–Ð¹ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚:\n" +
        "Ð¥Ð¾Ð´Ð¸: " + moves + ", Ñ‡Ð°Ñ: " + formatTime(seconds) +
        "\n\nÐŸÐ¾Ñ‚Ð¾Ñ‡Ð½Ð¸Ð¹ Ñ€ÐµÐºÐ¾Ñ€Ð´ Ð´Ð»Ñ " + size + "Ã—" + size + ":\n" +
        "Ð¥Ð¾Ð´Ð¸: " + prevData.moves + ", Ñ‡Ð°Ñ: " + formatTime(prevData.seconds)
      );
    }
  }
  // ---- ÐšÐ†ÐÐ•Ð¦Ð¬ Ð‘Ð›ÐžÐšÐ£ Ð Ð•ÐšÐžÐ Ð”Ð†Ð’ ----

  function showWin() {
    stopTimer();

    const resMoves = document.getElementById("resultMoves");
    const resTime = document.getElementById("resultTime");
    const resLevel = document.getElementById("resultLevel");

    if (resMoves) resMoves.textContent = moves;
    if (resTime) resTime.textContent = formatTime(seconds);
    if (resLevel) resLevel.textContent = size + "Ã—" + size;

    document.getElementById("game").classList.add("hidden");
    document.getElementById("win").classList.remove("hidden");

    // Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚Ð¸/Ð¾Ð½Ð¾Ð²Ð¸Ñ‚Ð¸ Ñ€ÐµÐºÐ¾Ñ€Ð´
    saveAndShowRecord();
  }

  function goHome() {
    window.location.href = "shag-games.html";
  }
</script>
