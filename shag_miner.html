<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>1SHAG –µ–∫–æ –º–∞–π–Ω–µ—Ä</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="assets/1shag/1SHAG_logo_512.png" />

  <!-- Ethers.js –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑ –≥–∞–º–∞–Ω—Ü–µ–º —Ç–∞ —Å–º–∞—Ä—Ç–∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞–º–∏ -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, #26263a 0, #050509 45%, #000000 100%);
      color: #f5f5f5;
    }

    .wrapper {
      width: 100%;
      max-width: 520px;
      padding: 16px;
    }

    .card {
      width: 100%;
      background: radial-gradient(circle at top, #181825 0, #070710 55%, #030307 100%);
      border-radius: 22px;
      padding: 20px 18px 18px;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.9);
      border: 1px solid rgba(255, 215, 0, 0.22);
      position: relative;
      overflow: hidden;
    }

    .bg-rack {
      position: absolute;
      inset: 0;
      pointer-events: none;
      opacity: 0.06;
      background-image:
        linear-gradient(90deg, rgba(255, 255, 255, 0.18) 1px, transparent 1px),
        linear-gradient(180deg, rgba(255, 255, 255, 0.08) 1px, transparent 1px);
      background-size: 46px 46px;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: relative;
      z-index: 1;
      margin-bottom: 12px;
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .title {
      font-size: 18px;
      font-weight: 700;
    }

    .subtitle {
      font-size: 12px;
      color: #c6c6d8;
    }

    .wallet-btn {
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      border: 1px solid #3b3b5a;
      background: #12121c;
      color: #f5f5f5;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    .wallet-btn:hover {
      border-color: #f1c550;
      box-shadow: 0 0 0 1px rgba(241, 197, 80, 0.4);
    }

    .wallet-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #ff8080;
    }

    .wallet-dot.ok {
      background: #9be38b;
    }

    .wallet-dot.warn {
      background: #f5d26c;
    }

    .center {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      margin-top: 4px;
    }

    .coin-wrap {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .coin-image-wrapper {
      width: 110px;
      height: 110px;
      border-radius: 50%;
      padding: 4px;
      background: radial-gradient(circle at 30% 20%, #e4f6ff 0%, #bfe3ff 30%, #7dc2ff 65%, #2468b2 100%);
      box-shadow:
        0 0 0 2px rgba(0, 0, 0, 0.9),
        0 4px 14px rgba(0, 0, 0, 0.9),
        0 0 26px rgba(255, 215, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      animation: coin-sway 8s ease-in-out infinite;
    }

    .coin-image {
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: 50%;
    }

    @keyframes coin-sway {
      0%   { transform: rotateY(0deg); }
      50%  { transform: rotateY(4deg); }
      100% { transform: rotateY(0deg); }
    }

    .info {
      margin-top: 10px;
      font-size: 11px;
      text-align: center;
      color: #7f8094;
      line-height: 1.4;
    }

    .small {
      font-size: 10px;
      color: #666885;
    }
  </style>
</head>

<body>
<div class="wrapper">
  <div class="card">
    <div class="bg-rack"></div>

    <div class="header">
      <div class="title-block">
        <div class="title">1SHAG —Å—É–ø–µ—Ä-–µ–∫–æ –º–∞–π–Ω–µ—Ä</div>
        <div class="subtitle">–û—Ñ—ñ—Ü—ñ–π–Ω–∏–π Faucet 1SHAG –∑ –ª—ñ–º—ñ—Ç–æ–º 100 SHAG / 24 –≥–æ–¥.</div>
      </div>
      <button id="connectBtn" class="wallet-btn">
        <span class="wallet-dot" id="walletDot"></span>
        <span id="walletLabel">–ü—ñ–¥–∫–ª—é—á–∏—Ç–∏ –≥–∞–º–∞–Ω–µ—Ü—å</span>
      </button>
    </div>

    <div class="center">
      <div class="coin-wrap">
        <div class="coin-image-wrapper">
          <img src="assets/1shag/1SHAG_logo_512.png" alt="–ú–æ–Ω–µ—Ç–∞ SHAG" class="coin-image" />
        </div>
      </div>

      <div style="width: 100%; max-width: 380px; margin-top: 20px;">
        <div id="statusText" class="status status-warn" style="text-align:center;">
          –ü—ñ–¥–∫–ª—é—á—ñ—Ç—å –≥–∞–º–∞–Ω–µ—Ü—å —É –º–µ—Ä–µ–∂—ñ BNB Smart Chain, —â–æ–± —Ä–æ–∑–ø–æ—á–∞—Ç–∏.
        </div>

        <button id="claimBtn" class="claim-btn" disabled>
          –û–¢–†–ò–ú–ê–¢–ò 100 SHAG
        </button>

        <div id="timerText" class="timer">
          –î–æ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è: 24:00:00
        </div>

        <div class="info">
          –ë–∞–ª–∞–Ω—Å Faucet —Ç–∞ –æ–±–º–µ–∂–µ–Ω–Ω—è –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è —É —Å–º–∞—Ä—Ç–∫–æ–Ω—Ç—Ä–∞–∫—Ç—ñ. <br />
          –£—Å—ñ –≤–∏–ø–ª–∞—Ç–∏ –ø—Ä–æ–∑–æ—Ä—ñ —Ç–∞ –≤—ñ–¥—Å—Ç–µ–∂—É—é—Ç—å—Å—è —á–µ—Ä–µ–∑ BscScan.
          <div class="small" id="faucetInfo"></div>
        </div>

        <!-- üîµ –ö–ù–û–ü–ö–ê –î–û–î–ê–¢–ò 1SHAG –í METAMASK -->
        <div style="margin-top: 15px; text-align:center;">
          <button id="addTokenBtn"
            style="padding: 10px 16px; border-radius: 999px; border: 1px solid #f1c550;
            background:#12121c; color:#f5f5f5; cursor:pointer; font-size:12px;">
            –î–û–î–ê–¢–ò 1SHAG –£ METAMASK
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // ================== –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø –ê–î–†–ï–° ==================
  const TOKEN_ADDRESS = "0xd4c35feccf968f4a73be4717524c087d7d0ed229"; // 1SHAG v2
  const FAUCET_ADDRESS = "0xea4b64d8eecbe54ba18444c6522a7f19f7ca152e"; // ShagFaucet
  const TOKEN_DECIMALS = 18;

  const TOKEN_ABI = [
    "function balanceOf(address) view returns (uint256)",
    "function decimals() view returns (uint8)"
  ];

  const FAUCET_ABI = [
    "function rewardAmount() view returns (uint256)",
    "function claimInterval() view returns (uint256)",
    "function isPaused() view returns (bool)",
    "function lastClaimTime(address) view returns (uint256)",
    "function faucetBalance() view returns (uint256)",
    "function canClaim(address) view returns (bool)",
    "function claim()",
    "event Claimed(address indexed user, uint256 amount, uint256 timestamp)"
  ];

  let provider;
  let signer;
  let userAddress = null;
  let tokenContract;
  let faucetContract;

  let rewardAmountBN = null;
  let claimIntervalSec = 24 * 60 * 60;
  let lastClaimTimeSec = 0;
  let isPaused = false;
  let faucetBalanceBN = null;

  let miningTimer = null;

  const connectBtn = document.getElementById("connectBtn");
  const walletDot = document.getElementById("walletDot");
  const walletLabel = document.getElementById("walletLabel");
  const counterValueEl = document.getElementById("counterValue");
  const progressFillEl = document.getElementById("progressFill");
  const statusTextEl = document.getElementById("statusText");
  const claimBtn = document.getElementById("claimBtn");
  const timerTextEl = document.getElementById("timerText");
  const faucetInfoEl = document.getElementById("faucetInfo");
  const addTokenBtn = document.getElementById("addTokenBtn");

  function setStatus(message, type = "warn") {
    statusTextEl.textContent = message;
    statusTextEl.className =
      "status " + (type === "ok" ? "status-ok" : type === "error" ? "status-error" : "status-warn");
  }

  function setWalletIndicator(status, text) {
    walletLabel.textContent = text;
    walletDot.classList.remove("ok", "warn");
    if (status === "ok") walletDot.classList.add("ok");
    if (status === "warn") walletDot.classList.add("warn");
  }

  function formatTimeLeft(sec) {
    if (sec <= 0) return "00:00:00";
    const h = String(Math.floor(sec / 3600)).padStart(2, "0");
    const m = String(Math.floor((sec % 3600) / 60)).padStart(2, "0");
    const s = String(sec % 60).padStart(2, "0");
    return `${h}:${m}:${s}`;
  }

  function trimTo8Decimals(str) {
    if (!str.includes(".")) return str + ".00000000";
    const [whole, frac] = str.split(".");
    const frac8 = (frac + "00000000").slice(0, 8);
    return `${whole}.${frac8}`;
  }

  async function initProvider() {
    if (!window.ethereum) {
      setStatus("–ì–∞–º–∞–Ω–µ—Ü—å –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å MetaMask –∞–±–æ —Å—É–º—ñ—Å–Ω–∏–π –≥–∞–º–∞–Ω–µ—Ü—å.", "error");
      return false;
    }
    provider = new ethers.providers.Web3Provider(window.ethereum);
    return true;
  }

  async function checkNetwork() {
    const network = await provider.getNetwork();
    if (network.chainId !== 56 && network.chainId !== 97) {
      setStatus("–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞ –º–µ—Ä–µ–∂–∞. –ü–µ—Ä–µ–º–∫–Ω—ñ—Ç—å –≥–∞–º–∞–Ω–µ—Ü—å –Ω–∞ BNB Smart Chain.", "error");
      setWalletIndicator("warn", "–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞ –º–µ—Ä–µ–∂–∞");
      return false;
    }
    const netName = network.chainId === 56 ? "BNB Smart Chain" : "BNB Testnet";
    setWalletIndicator("ok", `–ü—ñ–¥–∫–ª—é—á–µ–Ω–æ: ${netName}`);
    return true;
  }

  async function initContracts() {
    tokenContract = new ethers.Contract(TOKEN_ADDRESS, TOKEN_ABI, provider);
    faucetContract = new ethers.Contract(FAUCET_ADDRESS, FAUCET_ABI, provider);
  }

  async function loadFaucetParams() {
    try {
      rewardAmountBN = await faucetContract.rewardAmount();
      claimIntervalSec = (await faucetContract.claimInterval()).toNumber();
      isPaused = await faucetContract.isPaused();
      faucetBalanceBN = await faucetContract.faucetBalance();

      const rewardHuman = ethers.utils.formatUnits(rewardAmountBN, TOKEN_DECIMALS);
      faucetInfoEl.textContent =
        `–†–æ–∑–º—ñ—Ä –≤–∏–Ω–∞–≥–æ—Ä–æ–¥–∏: ${trimTo8Decimals(rewardHuman)} SHAG. ` +
        `–Ü–Ω—Ç–µ—Ä–≤–∞–ª –º—ñ–∂ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è–º–∏: ${Math.floor(claimIntervalSec / 3600)} –≥–æ–¥. `;

      if (faucetBalanceBN && !faucetBalanceBN.isZero()) {
        const fb = ethers.utils.formatUnits(faucetBalanceBN, TOKEN_DECIMALS);
        faucetInfoEl.textContent += `–ë–∞–ª–∞–Ω—Å Faucet: ${trimTo8Decimals(fb)} SHAG.`;
      } else {
        faucetInfoEl.textContent += "Faucet –ø–æ—Ä–æ–∂–Ω—ñ–π –∞–±–æ —â–µ –Ω–µ –ø–æ–ø–æ–≤–Ω–µ–Ω–∏–π.";
      }
    } catch (e) {
      console.error(e);
      setStatus("–ù–µ –≤–¥–∞–ª–æ—Å—è –ø—Ä–æ—á–∏—Ç–∞—Ç–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ Faucet.", "error");
    }
  }

  async function refreshUserState() {
    if (!userAddress || !faucetContract) return;

    try {
      const last = await faucetContract.lastClaimTime(userAddress);
      lastClaimTimeSec = last.toNumber();
    } catch (e) {
      lastClaimTimeSec = 0;
    }

    const nowSec = Math.floor(Date.now() / 1000);
    let elapsed = lastClaimTimeSec === 0 ? claimIntervalSec : nowSec - lastClaimTimeSec;
    if (elapsed < 0) elapsed = 0;

    const progress = Math.min(1, elapsed / claimIntervalSec);
    const scale = ethers.BigNumber.from(Math.floor(progress * 1e8));
    const earned = rewardAmountBN
      ? rewardAmountBN.mul(scale).div(ethers.BigNumber.from(1e8))
      : ethers.BigNumber.from(0);

    let earnedHuman = rewardAmountBN
      ? ethers.utils.formatUnits(earned, TOKEN_DECIMALS)
      : "0";
    earnedHuman = trimTo8Decimals(earnedHuman);

    counterValueEl.textContent = earnedHuman;
    progressFillEl.style.width = (progress * 100).toFixed(1) + "%";

    let canClaimFlag = false;
    try {
      canClaimFlag = await faucetContract.canClaim(userAddress);
    } catch {}

    const remainingSec = Math.max(0, claimIntervalSec - elapsed);

    if (isPaused) {
      claimBtn.disabled = true;
      setStatus("Faucet –Ω–∞ –ø–∞—É–∑—ñ.", "warn");
    } else if (faucetBalanceBN && faucetBalanceBN.isZero()) {
      claimBtn.disabled = true;
      setStatus("Faucet –ø–æ—Ä–æ–∂–Ω—ñ–π.", "warn");
    } else if (canClaimFlag) {
      claimBtn.disabled = false;
      setStatus("–î–æ—Å—Ç—É–ø–Ω–æ –¥–æ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è 100 SHAG.", "ok");
    } else {
      claimBtn.disabled = true;
      setStatus("–û—á—ñ–∫—É–π—Ç–µ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è —Ç–∞–π–º–µ—Ä–∞.", "warn");
    }

    timerTextEl.textContent =
      "–î–æ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è: " + formatTimeLeft(remainingSec);
  }

  function startMiningLoop() {
    if (miningTimer) clearInterval(miningTimer);
    miningTimer = setInterval(async () => {
      if (!userAddress || !faucetContract || !rewardAmountBN) return;

      const nowSec = Math.floor(Date.now() / 1000);
      let elapsed =
        lastClaimTimeSec === 0 ? claimIntervalSec : nowSec - lastClaimTimeSec;
      if (elapsed < 0) elapsed = 0;

      const progress = Math.min(1, elapsed / claimIntervalSec);
      const scale = ethers.BigNumber.from(Math.floor(progress * 1e8));
      const earned = rewardAmountBN
        ? rewardAmountBN.mul(scale).div(ethers.BigNumber.from(1e8))
        : ethers.BigNumber.from(0);

      let earnedHuman = rewardAmountBN
        ? ethers.utils.formatUnits(earned, TOKEN_DECIMALS)
        : "0";
      earnedHuman = trimTo8Decimals(earnedHuman);

      counterValueEl.textContent = earnedHuman;
      progressFillEl.style.width = (progress * 100).toFixed(1) + "%";

      const remainingSec = Math.max(0, claimIntervalSec - elapsed);
      timerTextEl.textContent =
        "–î–æ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è: " + formatTimeLeft(remainingSec);
    }, 1000);
  }
  // ================== –û–ë–†–û–ë–ù–ò–ö–ò –ö–ù–û–ü–û–ö ==================

  // –ü–Ü–î–ö–õ–Æ–ß–ï–ù–ù–Ø –ì–ê–ú–ê–ù–¶–Ø
  connectBtn.addEventListener("click", async () => {
    try {
      const ok = await initProvider();
      if (!ok) return;

      const networkOk = await checkNetwork();
      if (!networkOk) return;

      const accounts = await provider.send("eth_requestAccounts", []);
      if (!accounts || accounts.length === 0) {
        setStatus("–ê–¥—Ä–µ—Å–∞ –≥–∞–º–∞–Ω—Ü—è –Ω–µ –æ—Ç—Ä–∏–º–∞–Ω–∞.", "error");
        return;
      }

      userAddress = accounts[0];
      signer = provider.getSigner();

      setWalletIndicator("ok", userAddress.slice(0, 6) + "..." + userAddress.slice(-4));

      await initContracts();
      await loadFaucetParams();
      await refreshUserState();

      startMiningLoop();
    } catch (e) {
      console.error(e);
      setStatus("–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –≥–∞–º–∞–Ω—Ü—è.", "error");
    }
  });


  // –ö–ù–û–ü–ö–ê CLAIM (–æ—Ç—Ä–∏–º–∞—Ç–∏ 100 SHAG)
  claimBtn.addEventListener("click", async () => {
    if (!userAddress || !faucetContract) return;

    try {
      claimBtn.disabled = true;
      setStatus("–ü—ñ–¥—Ç–≤–µ—Ä–¥—ñ—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —É MetaMask‚Ä¶", "warn");

      const faucetWithSigner = faucetContract.connect(signer);
      const tx = await faucetWithSigner.claim();

      setStatus("–û—á—ñ–∫—É—î–º–æ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó‚Ä¶", "warn");
      await tx.wait();

      setStatus("–£—Å–ø—ñ—Ö! 100 SHAG –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ –Ω–∞ –≤–∞—à –≥–∞–º–∞–Ω–µ—Ü—å.", "ok");

      await loadFaucetParams();
      await refreshUserState();
    } catch (e) {
      console.error(e);
      setStatus("–ü–æ–º–∏–ª–∫–∞ –∞–±–æ –≤—ñ–¥–º–æ–≤–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó.", "error");
      await refreshUserState();
    }
  });


  // –ö–ù–û–ü–ö–ê –î–û–î–ê–¢–ò 1SHAG –£ METAMASK
  addTokenBtn.addEventListener("click", async () => {
    if (!window.ethereum) {
      setStatus("MetaMask –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å –≥–∞–º–∞–Ω–µ—Ü—å.", "error");
      return;
    }

    try {
      const wasAdded = await window.ethereum.request({
        method: "wallet_watchAsset",
        params: {
          type: "ERC20",
          options: {
            address: TOKEN_ADDRESS,
            symbol: "SHAG",
            decimals: TOKEN_DECIMALS,
            image: "https://1shag.github.io/shag-site/assets/1shag/1SHAG_logo_512.png"
          }
        }
      });

      if (wasAdded) {
        setStatus("–¢–æ–∫–µ–Ω 1SHAG –¥–æ–¥–∞–Ω–æ —É MetaMask!", "ok");
      } else {
        setStatus("–î–æ–¥–∞–≤–∞–Ω–Ω—è —Ç–æ–∫–µ–Ω–∞ —Å–∫–∞—Å–æ–≤–∞–Ω–æ —É MetaMask.", "warn");
      }
    } catch (e) {
      console.error(e);
      setStatus("–ù–µ –≤–¥–∞–ª–æ—Å—è –¥–æ–¥–∞—Ç–∏ —Ç–æ–∫–µ–Ω —É MetaMask.", "error");
    }
  });
</script>

</body>
</html>
